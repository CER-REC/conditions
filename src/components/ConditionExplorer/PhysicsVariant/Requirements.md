# iLab Requirements
The guide is a circular element that has multiple functions. It provides hints about what the visitor looking at, it can be expanded to reveal more detailed informational panels, it can also be dragged around by the user sometimes. When the user drags the guide it reveals keywords in the conditions explorer. This interaction is only available when a pink stroke surrounds the circle to indicate that it is an interactive element.

## The Guide - Closed
The closed guide loads at a fixed position in V1 as a non-interactive element at first. After a very short time, it will then become interactive in V1 (as an object in the physics simulation), and when the user leaves V1, it will get a series of set positions during the transition from V1-V2. While it is interactive, the guide can be dragged around the visible screen by the visitor and, in doing so, reveals keywords. In this state the guide will display instructional messages. When clicked, the guide will expand to its open state.

## Animate In Interactive Ring
Upon loading the default state of the guide will be closed and at a fixed position (circle center at 66% width and 50% height of the conditions explorer container). At this time there are no conditions popped and the guide displays the text “these lines are conditions”. Then a white circle with a pink stroke with 5px larger radius than the guide will slide horizontally into the frame from the left side of the screen (also at 50% height), reveal keywords as it slides over the conditions on its way in, and attach itself to the base of the guide.

There should be a 500 ms delay before the pink circle begins to slide in, and it should take 1200 ms to reach the circle using an “out” timing curve (we use CubicOut), so the bulk of movement happens at the front of the timing window. Note to VizworX: after we see the final implementation and have had some time to reflect on our design, we may tweak these parameters to give a better feel.

The circle with the pink stroke introduces visitors to our styling of interactive elements with a pink stroke. The guide will only be interactive as long as the circle with the pink stroke is attached.

## Clicking and Dragging the Guide
As long as there is a pink circle around the guide, it can be clicked and dragged by the user. As it is dragged over the condition rectangles in the background (note: these rectangles are only visual and are not part of the physics engine yet), the conditions get “popped” to show their underlying keyword; this keyword is then placed into the physics simulation and can collide with other popped keywords or the circle itself, and its “home” rectangle in the background is hidden.

When the guide collides with a popped keyword, a small force is applied to give the illusion of a slightly frictionless surface (see prototype details below for more). This force is not applied when keywords collide with each other.

## Returning Keywords to the Background
As soon as conditions are popped, they are placed on a timer of 5000 ms and will return to the background once the timer has expired. There is also a limit of 75 popped keywords on the screen at once, and if the limit is exceeded, the oldest keywords are returned (this number is open for adjustment). There are three things that can block a keyword from returning to the background: the guide circle being opened, the guide hovering over the keyword’s home location, and the keyword being selected by the user. In either case, when all these conditions are no longer true, the condition will return to the background.

When a keyword returns, it is immediately removed from the physics engine and all the changes that happen are visual only. The keyword will transition to its background location (while keeping the text visible), it will shrink to 70% of the size it was when it was popped, and it will take on the background color of its home rectangle. It will then remain there for a brief time before it fades out at the same time as the home rectangle fades in (this “fade out fade in” behavior creates a nice “shimmer” effect which can cascade throughout the visualization if many keywords near each other return in quick succession).

## Changing Messages on the Guide
As mentioned above, the first message on the guide is “these lines are conditions”. Once the pink stroked circle has animated in the message on the circle should change to “Reveal condition keywords by dragging”. This is the first in a list of messages that the circle should rotate through in order. The next two messages are “Click to learn what a condition is” then “Select a keyword and scroll down to continue”. When the guide is clicked to expand or clicked and dragged around, the text in the circle should disappear, and none of these texts should populate the guide while the interaction is taking place. When the interaction has stopped, display the next message. If no interaction has taken place for a period of time (let’s say 10 seconds for now, but make this adjustable) this can also trigger the display of the next message. When a keyword has been selected the guide should display the text “Scroll Down” and should continue to display this message until the first transition frame. The messages can appear and disappear from the guide using a simple fade in/out if they are updating as a result of the timer.

## The Guide - Open
When the guide is clicked it will expand to reveal a series of informational panels that provide context for conditions, external links and guidance on continuing to interact with the visualization.

## Animating Open
From the moment the guide is set to open, no additional keywords may be popped and all popped keywords will be locked from returning to the background (see prototype below for more details). The circle will simultaneously center on the conditions explorer area (horizontally and vertically) and expand to fill the space, it will collide with already-popped keywords and push them out of the way, but the extra “circle collision” force will be turned off so that the keywords are not sent flying off the screen. When the circle expands it should not display text inside and it should leave behind the pink ring that indicates interactivity. The expanded guide cannot be moved by the visitor. Once the guide is expanded the Expanded content can fade in quickly or just appear if that looks ok.

## Animating Closed
When the user collapses the circle, all already-popped keywords return to the exact same position and rotation they were in before the circle was expanded (this should be saved when the circle is expanded and animated directly, without the use of physics). Once the guide is done collapsing, the old behavior of the guide returns; the pink interactive circle should quickly fade back in, the already-popped keywords can enter back into the physics system, and the circle can once again be dragged and pop new keywords.

## Expanded Content
The content within the expanded circle replaces the content previously within the banner. There is a series of panels each following the formula of heading, a short statement (300 characters) and (if relevant) an external link to target pages of the NEB website. The heading, statement, and each link should be separated by a double space with pararaph sized leading. The following is an example, but contents will shift in consultation the NEB.

Links should open in a new tab.

Visitors will be able to page through the panels of the expanded guide, using buttons. Progress through the series will be visually apparent by highlighting dots as seen above. If there is no page before of after the current do not display the button to navigate in that direction.

Interaction: on click over button

Result: Slide left/right depending on the direction of the arrow, 300MS.

The position of the circle cannot be changed while the circle is expanded. The keywords around the circle can be interacted with. If a keyword is selected while the circle is expanded then the circle will immediately animate closed and display the message that prompts the user to scroll down as specified in section above: Changing Messages on the Guide If the visitor clicks anywhere outside the expanded circle it will prompt the circle to collapse.


The conditions explorer (formerly waterfall) provides an accessible entry point into conditions without requiring visitors to understand much about them. It shows a semi-random sample of conditions, represented as lines that are positioned in a rigid layout. As a result of dragging the guide across the screen, conditions touched by the guide will transform into keywords that have been extracted from the condition. The keywords utilize the same physics simulation as the previous waterfall and collide with each other and the guide, however, gravity is turned off so that the movement appears more like objects being pushed around on a desk. A maximum number of keywords will be displayed at one time, then the oldest keywords will return back to their position and fade back into conditions. If the user drags the guide over those returned conditions they will pop the same keyword again so the visitor doesn’t “lose” conditions they are interested in. This introduces visitors to the text-based data of conditions and allows them to enter into the visualization with a subject of interest to them.

In keeping with the previous waterfall, this exploration provides a playful, attractive way to find conditions of interest without requiring visitors to immediately understand the complex surroundings that are revealed in the full visualization in View 2. Conditions can be selected, and once they are, the visitor is invited to move to View 2 to gain a deeper understanding. The choice to show a random sample stems from the goal of not overwhelming the visitor with all information at once (there are approximately 7000 conditions in the dataset) and has the added benefit of making it possible to gain the intriguing, playful interaction with good enough performance to run on a variety of web browsers.

### Addressing the Removal of “Search” in View 1
We have excluded search from this view due to V1 being a representation of a data subset, and because a search field puts a great deal of pressure on the visitor to have clear intentions. In lieu of search we expose keywords that we have extracted as the sole means of exploring the data in this initial stage. By increasing the limitations of view 1 we create a more lightweight opportunity for the initial exploration. To complement this we also present the ability to skip view 1 more easily and go to either the company or location wheel.

### Implementation Notes
Here are the details of implementation decisions made while coding the prototype. Note that, in some cases, shortcuts were taken in the prototype to just get the main idea across. Unless otherwise specified, the design document should be followed if it disagrees with something in the prototype. Please refer directly to the prototype’s codebase to see exactly how the features were implemented. If we didn’t specify something explicitly in the document, but it has been coded in the prototype, assume the prototype’s implementation is the way we intended, and feel free to ask us specific questions at any time.

We use the Box2D physics library, which seems standard in browser-based physics sandboxes. Box2D is not tied to rendering or data management, so it can work with SVG/Canvas or D3/React equally well, and the JS library has been around for a long time so it should play nicely with IE11.
The SVG in the prototype has resolution 970x700, and we map the height of this SVG to 20 Box2D physics units. This ratio is important, because the size of the physics world impacts what constants we use for things like applying forces. We then built screenToWorld and worldToScreen functions to convert between screen space and world space as necessary, so we can measure dimensions of objects in both screen and world space interchangeably.
When tiling the bars in the background, we start/end 20px off-screen in all directions to improve the tiling feel. The width of the bars matches the exact width of the (smaller, 70% scale) keyword text that goes on top of the bar, and the height of the bar is clamped to 7 pixels. There are 22 pixels between each bar, both horizontally and vertically; this gap is important so that lots of popped keywords don’t overlap and create jitter. Bars in the background exist on screen only, they are not in the physics engine until popped. The background bars are randomly chosen to be 1 of 3 specific colors, with the caveat that no two bars horizontally next to each other can be the same color.
The circle is represented as a static object in the physics simulation. Clicking and dragging the circle directly sets the position of the object (that is to say, we use SetPosition and let the engine resolve, rather than applying velocity or forces to move it). VizworX are welcome to try to improve performance or stability by moving the circle without using SetPosition, which can sometimes cause some slight jitter when it pops multiple words quickly, but we are happy enough with the current solution.
The circle will pop a keyword when it covers up any part of the background bar (we use a circle/rectangle intersection test). The keyword pops in place (that is to say, the center of the popped keyword is placed on top of the center of the background rectangle), and will likely be immediately pushed by the circle to some new location as the physics engine resolves collisions (see next point). Because the total number of bars to test intersection against is “only” around 300, the prototype just simply loops over each bar each frame the circle is moving to mark which bars are covered up. Whether this brute force solution is too costly for older machines is something to look into; using a nice data structure like a quadtree to simplify these tests might be worthwhile if VizworX wants to see performance improvement on older browsers.
Whenever the circle collides with any popped keyword object, we apply a small force of magnitude 10 in the direction of the mouse movement to the keyword on the exact point of contact. This creates a slight slide effect and prevents keywords from getting too bunched up around the circle, especially when the words are initially popped. It also lets the circle act more playfully as it pushes existing keywords around during mouse movement. Note that the magnitude is kept constant (and is not related to how fast the mouse is moving); this is a choice that prevents people from clearing the screen too easily if they’re moving super rapidly, while also still being able to create some meaningful disturbances while moving the mouse slowly.
To simulate the slide effect, the world has no gravity but every non-circle object in the physics engine has a linear damping of 2.5 and an angular damping of 2.5. This will slow down the linear and angular velocity of every object in the physics simulation over time until it is stopped.
When the circle expands because it was clicked, no new keywords should be popped but the physics engine should keep running so that the keywords already on screen can be pushed by the expanding circle. All previously popped keywords should not be allowed to return to the background while the circle is expanded, and the circle cannot be dragged by the user while expanded (or during its expanding/collapsing animations).
Because physics fixtures cannot be resized once created, each frame the circle’s fixture must be destroyed and recreated with a new radius and position as it grows and moves to the center of the screen. Because this tends to create a bad overlap with keywords, especially if the circle grows quickly, we create a slightly larger physics circle in the background to push the keywords before the visible circle reaches it. This larger circle shrinks as the circle grows, so that when the circle reaches its final position and size, the physics representation matches the visual circle as normal. Specific details about this can be found in the prototype in the circleMouseUp function.
When the circle shrinks back down because it was clicked, the physics engine is effectively turned off and the popped keywords are visually animated back to their old positions and rotations before the circle had expanded. As soon as the circle fully shrinks and the keywords fully animate back, the physics simulation is turned back on and the keywords can be moved again by the circle.
Keywords are saved in the order they were popped. They are returned to the background after a set amount of time (5 seconds), or the oldest one is immediately returned if there are more keywords popped than some threshold (the prototype has threshold 75, but this number is up for discussion with VizworX based on how their implementation and browser tests go). Note that there are a few things that can prevent a keyword from returning to the background under any circumstance, such as the circle being clicked and expanded (or in the process of animating being grown or shrunk due to a click), as well as the circle hovering on top of the keyword’s home bar in the background. If a keyword tries to return but cannot for these reasons, it is queued up and returned the next time it can.
As soon as the animation triggers to send a popped keyword to the background, it is removed from the physics simulation and is only animated visually. Returning to the background is 3-stage transition:
1) the keyword rotates to a horizontal position, its center moves back to the center of its home rectangle, it takes on the color of its home rectangle, and it shrinks from 100% scale to 70% scale all at the same time (1000 ms).
2) the keyword remains in this position for visual effect (2000 ms). Note that any keyword that is transitioning to the background cannot be clicked or selected. If the user wants to click a “background” keyword, they can re-pop it by moving the circle overtop.
3) the keyword fades out at the same time as the background rectangle fades back in, which creates a nice “shimmer” effect (1000 ms).
Note that special care needs to be taken so that rotating the keywords back to a horizontal angle is done with as little rotation as possible (clamping between 0 and 2pi, and choosing to rotate clockwise or counter-clockwise). Often times in the physics engine, these keywords will get pushed around such that their rotation is a very large positive or negative number, and simply transitioning the angle back to 0 would cause a violent “unwinding” of the keyword.

## Collision with other elements
When revealed keywords are moving about the screen they should not collide with edges or any element on the screen aside from the guide and other revealed keywords. Sections 1, 4 and 5 live on top of white space which should sit in front of keywords. This means keywords will not collide with boundaries of their container but they will begin to not be visible at the boundaries of the container.

## Selecting a Keyword/Condition
Keywords that appear in the foreground (ie. they haven’t returned back to their spawning position yet) are clickable. When the visitor selects (clicks on) one of the keywords, the selected keyword will be styled orange and the guide will updated with the the message “Scroll Down”. As the visitor scrolls:

- The selected condition and guide will slowly animate towards the first frame of the transition from V1-V2 and the full text of the condition will being to appear around the selected keyword (which will be a word in the body of the text)

- The skip to location wheel button will fade away, and the info button will fade away

- The skip to location wheel button will remain in place

- Everything else on the screen (the pink ring around the guide, all popped keywords and conditions, the title) will leave the screen as the visitor scrolls. These elemments should be frozen in relation to eachother but move upwards as the visitor scrolls in the way that a normal page with static content would.

The visitor should be able to reverse this if they scroll back up, and have the physics resume so they can move the guide around and select a different condition if they want. While scrolling, no physics interaction should take place (because the pink guide is the object that causes the objects to be disturbed, and it is not moving within the physics frame).

If the visitor selects a condition it remains selected, and blocked from returning back to position, until the visitor selects a different condition or moves the guide again. Moving the guide, or expanding the guide, will result in the deselection of the keyword/condition. Interaction with the skip buttons or the about button will not deselect the keyword/condition; this selection will carry through to V2.
